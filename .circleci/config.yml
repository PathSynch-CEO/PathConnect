version: 2.1

jobs:
  deploy-pathsynch-frontend:
    machine:
      resource_class: pathsynch-labs/pathsynch-aws-runner

    steps:
      - checkout

      - run:
          name: "Build React Frontend"
          command: |
            echo "üöÄ Building PathSynch Frontend (PathConnect)"
            # Clean and prepare isolated workspace
            sudo rm -rf /opt/circleci-workspace/pathsynch-frontend
            sudo mkdir -p /opt/circleci-workspace/pathsynch-frontend
            sudo chown -R circleci:circleci /opt/circleci-workspace/pathsynch-frontend
      
            echo "üìÅ Copying project into workspace..."
            cp -r /home/circleci/project/* /opt/circleci-workspace/pathsynch-frontend/
            cd /opt/circleci-workspace/pathsynch-frontend
      
            echo "üß± Installing dependencies..."
            npm ci --legacy-peer-deps
      
            echo "üèóÔ∏è Running production build (CI=false to ignore ESLint warnings)..."
            CI=false npm run build
      
            echo "‚úÖ Build completed successfully."
            ls -al build | head -n 10


      - run:
          name: "Deploy Frontend Build to EC2"
          command: |
            set -eo pipefail
            echo "üöÄ Starting deployment to /home/pathsync-frontend/"
            LIVE_DIR="/home/pathsync-frontend"
            BUILD_DIR="/opt/circleci-workspace/pathsynch-frontend/build"
            TARGET_DIR="${LIVE_DIR}/Merchant"
            TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
            BACKUP_DIR="${LIVE_DIR}/Merchant_backup_${TIMESTAMP}"

            echo "üì¶ Backing up current Merchant directory..."
            if [ -d "${TARGET_DIR}" ]; then
              sudo mv ${TARGET_DIR} ${BACKUP_DIR}
              echo "‚úÖ Backup created at ${BACKUP_DIR}"
            else
              echo "‚ÑπÔ∏è No previous Merchant folder found ‚Äî fresh deployment."
            fi

            echo "üìÇ Creating new Merchant folder..."
            sudo mkdir -p ${TARGET_DIR}
            sudo cp -r ${BUILD_DIR}/* ${TARGET_DIR}/
            sudo chown -R pathsync-frontend:pathsync-frontend ${TARGET_DIR}
            sudo chmod -R 775 ${TARGET_DIR}
            echo "‚úÖ New build deployed to ${TARGET_DIR}"

      - run:
          name: "Reload NGINX and Health Check"
          command: |
            echo "üîÑ Reloading NGINX..."
            sudo nginx -t
            sudo systemctl reload nginx
            sudo systemctl status nginx --no-pager || true

            echo "üîç Checking frontend availability..."
            if curl -s --max-time 10 http://localhost | grep -q "<!DOCTYPE html>"; then
              echo "‚úÖ Frontend deployed and responding locally."
            else
              echo "‚ö†Ô∏è Deployment verification failed ‚Äî rolling back."
              sudo rm -rf /home/pathsync-frontend/Merchant
              sudo mv ${BACKUP_DIR} /home/pathsync-frontend/Merchant
              sudo nginx -t && sudo systemctl reload nginx
              echo "üîÅ Rollback complete."
              exit 1
            fi

            echo "üéØ Deployment successful! Visit https://pathsynch.com"
            exit 0

workflows:
  version: 2
  deploy_frontend_workflow:
    jobs:
      - deploy-pathsynch-frontend
