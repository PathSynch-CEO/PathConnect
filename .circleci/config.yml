version: 2.1

jobs:
  deploy-pathsynch-frontend:
    machine:
      resource_class: pathsynch-labs/pathsynch-aws-runner

    steps:
      - checkout

      - run:
          name: "Build React Frontend"
          command: |
            echo "ğŸš€ Building PathSynch Frontend (PathConnect)"
            sudo rm -rf /opt/circleci-workspace/pathsynch-frontend
            sudo mkdir -p /opt/circleci-workspace/pathsynch-frontend
            sudo chown -R circleci:circleci /opt/circleci-workspace/pathsynch-frontend
            echo "ğŸ“ Copying project into workspace..."
            cp -r . /opt/circleci-workspace/pathsynch-frontend/
            cd /opt/circleci-workspace/pathsynch-frontend
            echo "ğŸ§± Installing dependencies..."
            npm ci --legacy-peer-deps
            echo "ğŸ—ï¸ Running production build (CI=false to ignore ESLint warnings)..."
            CI=false npm run build
            echo "âœ… Build completed successfully."
            ls -al build | head -n 10


      - run:
          name: "Deploy Frontend Build to EC2"
          command: |
            set -eo pipefail
            echo "ğŸš€ Starting deployment to /home/pathsync-frontend/"
            LIVE_DIR="/home/pathsync-frontend"
            BUILD_DIR="/opt/circleci-workspace/pathsynch-frontend/build"
            TARGET_DIR="${LIVE_DIR}/Merchant"
            TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
            BACKUP_DIR="${LIVE_DIR}/Merchant_backup_${TIMESTAMP}"

            echo "ğŸ“¦ Backing up current Merchant directory..."
            if [ -d "${TARGET_DIR}" ]; then
              sudo mv ${TARGET_DIR} ${BACKUP_DIR}
              echo "âœ… Backup created at ${BACKUP_DIR}"
            else
              echo "â„¹ï¸ No previous Merchant folder found â€” fresh deployment."
            fi

            echo "ğŸ“‚ Creating new Merchant folder..."
            sudo mkdir -p ${TARGET_DIR}
            sudo cp -r ${BUILD_DIR}/* ${TARGET_DIR}/
            sudo chown -R pathsync-frontend:pathsync-frontend ${TARGET_DIR}
            sudo chmod -R 775 ${TARGET_DIR}
            echo "âœ… New build deployed to ${TARGET_DIR}"

      - run:
          name: "Reload NGINX and Health Check"
          command: |
            echo "ğŸ”„ Reloading NGINX..."
            sudo nginx -t
            sudo systemctl reload nginx
            sudo systemctl status nginx --no-pager || true

            echo "ğŸ” Checking frontend availability..."
            if curl -s --max-time 10 http://localhost | grep -q "<!DOCTYPE html>"; then
              echo "âœ… Frontend deployed and responding locally."
            else
              echo "âš ï¸ Deployment verification failed â€” rolling back."
              sudo rm -rf /home/pathsync-frontend/Merchant
              sudo mv ${BACKUP_DIR} /home/pathsync-frontend/Merchant
              sudo nginx -t && sudo systemctl reload nginx
              echo "ğŸ” Rollback complete."
              exit 1
            fi

            echo "ğŸ¯ Deployment successful! Visit https://pathsynch.com"
            exit 0

workflows:
  version: 2
  deploy_frontend_workflow:
    jobs:
      - deploy-pathsynch-frontend
