version: 2.1

jobs:
  deploy-pathsynch-frontend:
    machine:
      resource_class: pathsynch-labs/pathsynch-aws-runner

    steps:
      - checkout

      - run:
          name: "ğŸš€ Build React Frontend (PathConnect)"
          command: |
            set -eo pipefail
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ğŸš€ Building PathSynch Frontend (PathConnect)"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            # ğŸ§± Prepare isolated workspace (reuse same base as APIs)
            sudo rm -rf /opt/circleci-workspace/pathsynch-frontend
            sudo mkdir -p /opt/circleci-workspace/pathsynch-frontend
            sudo chown -R circleci:circleci /opt/circleci-workspace/pathsynch-frontend

            # ğŸ“ Copy project source into workspace safely
            echo "ğŸ“ Copying source files into workspace..."
            rsync -av --exclude '.git' --exclude 'node_modules' --exclude '.circleci' ./ /opt/circleci-workspace/pathsynch-frontend/


            cd /opt/circleci-workspace/pathsynch-frontend
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --legacy-peer-deps

            echo "ğŸ—ï¸ Building production bundle..."
            BUILD_STATUS=0
            BUILD_LOG_OK=true
            
            (
              set +e
              set +o pipefail
            
              CI=false npm run build
              BUILD_STATUS=$?
            
              echo "âœ… Build complete. Contents:"
              ls -al build | head -n 10 || true
            
              # capture result in a temp file the parent shell can read
              echo $BUILD_STATUS > /tmp/build_status_code
            )
            
            # read back actual npm build exit code
            BUILD_STATUS=$(cat /tmp/build_status_code)
            
            if [ "$BUILD_STATUS" -ne 0 ]; then
              echo "âŒ React build failed with exit code $BUILD_STATUS"
              exit $BUILD_STATUS
            fi
            
            echo "âœ… React build succeeded."


      - run:
          name: "Deploy Frontend Build to EC2"
          command: |
            set -eo pipefail
            echo "ğŸš€ Starting clean deployment..."
            LIVE_DIR="/home/pathsync-frontend"
            BUILD_DIR="/opt/circleci-workspace/pathsynch-frontend/build"
            TARGET_DIR="${LIVE_DIR}/Merchant"
            TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
            BACKUP_DIR="${LIVE_DIR}/Merchant_backup_${TIMESTAMP}"

            echo "ğŸ“¦ Backing up existing Merchant directory..."
            if [ -d "${TARGET_DIR}" ]; then
              sudo mv ${TARGET_DIR} ${BACKUP_DIR}
              echo "âœ… Backup created at ${BACKUP_DIR}"
            else
              echo "â„¹ï¸ No previous Merchant directory found, proceeding fresh."
            fi

            echo "ğŸ§± Creating new Merchant directory..."
            sudo mkdir -p ${TARGET_DIR}

            echo "ğŸ“‚ Moving build folder into Merchant..."
            sudo mv ${BUILD_DIR} ${TARGET_DIR}/build

            echo "ğŸ”§ Setting permissions..."
            sudo chown -R pathsync-frontend:pathsync-frontend ${TARGET_DIR}
            sudo chmod -R 775 ${TARGET_DIR}

            echo "ğŸ§© Verifying deployment..."
            if [ -f "${TARGET_DIR}/build/index.html" ]; then
              echo "âœ… Frontend build deployed successfully at ${TARGET_DIR}/build"
            else
              echo "âŒ Deployment failed â€” index.html missing!"
              exit 1
            fi
            
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ğŸ”„ Reloading NGINX configuration"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            sudo nginx -t
            sudo systemctl reload nginx
            sudo systemctl status nginx --no-pager || true

            echo "ğŸ” Checking frontend availability..."
            sleep 10  # give workers time to spin up
            
           if curl -s --max-time 15 https://pathsynch.com | grep -qi "<!doctype html"; then
              echo "âœ… Frontend successfully served from NGINX (200 OK)."
            else
              echo "âš ï¸ Health check failed â€” initiating rollback..."
              sudo rm -rf ${TARGET_DIR}
              sudo mv ${BACKUP_DIR} ${TARGET_DIR}
              sudo chown -R pathsync-frontend:pathsync-frontend ${TARGET_DIR}
              sudo nginx -t && sudo systemctl reload nginx
              echo "ğŸ” Rollback complete."
              exit 1
            fi

            echo "ğŸ¯ Deployment completed successfully!"
            echo "ğŸŒ Live at: https://pathsynch.com"
            exit 0

workflows:
  version: 2
  deploy_frontend_workflow:
    jobs:
      - deploy-pathsynch-frontend
